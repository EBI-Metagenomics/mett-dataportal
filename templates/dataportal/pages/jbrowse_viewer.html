{% extends "base.html" %}
{% block content %}
    {% load static %}
    <div>
        <nav class="vf-breadcrumbs" aria-label="Breadcrumb">
            <ul class="vf-breadcrumbs__list | vf-list vf-list--inline">
                <li class="vf-breadcrumbs__item">
                    <a href="{% url 'home' %}" class="vf-breadcrumbs__link">Search</a>
                </li>
                <li class="vf-breadcrumbs__item" aria-current="location">
                    Genome View
                </li>
            </ul>
        </nav>
    </div>

    <!-- Display the additional information -->
    <div class="vf-box vf-box--primary">
        <h2>{{ species_name }}: {{ isolate_name }}</h2>
        <p><strong>Assembly Name:</strong> {{ assembly_name }}</p>
        <p><strong>ENA Accession:</strong> {{ assembly_accession }}</p>
        <p><strong>Assembly:</strong> <a href="{{ fasta_url }}">{{ fasta_file_name }}</a></p>
        <p><strong>Annotations:</strong> <a href="{{ gff_url }}">{{ gff_file_name }}</a></p>
    </div>

    <!-- Genome Viewer -->
    <h1>Genome Viewer for {{ isolate_name }}</h1>
    <div id="jbrowse_linear_genome_view" style="height: 600px;"></div>

    <!-- Load React and ReactDOM -->
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>

    <!-- JBrowse Linear Genome View -->
    <script
        src="//unpkg.com/@jbrowse/react-linear-genome-view/dist/react-linear-genome-view.umd.development.js"
        crossorigin
    ></script>

    <!-- Initialize JBrowse2 after scripts have loaded -->
    <script type="module">
        const {
            createViewState,
            JBrowseLinearGenomeView,
            loadPlugins,
        } = JBrowseReactLinearGenomeView;

        const { createElement } = React;
        const { render } = ReactDOM;

        console.log('Loading plugins...');
        loadPlugins([
            {
                name: 'GWAS',
                url: 'https://unpkg.com/jbrowse-plugin-gwas/dist/jbrowse-plugin-gwas.umd.production.min.js',
            },
        ]).then(loadedPlugins => {
            console.log('Plugins loaded:', loadedPlugins);

            // Manually initializing view state
            const viewState = createViewState({
                assembly: {
                    name: '{{ assembly_name }}',
                    sequence: {
                        type: 'ReferenceSequenceTrack',
                        trackId: 'reference',
                        adapter: {
                            type: 'FromConfigSequenceAdapter',
                            fastaLocation: {
                                uri: '{{ fasta_url }}',
                            },
                        },
                    },
                },
                tracks: [
                    {
                        type: 'FeatureTrack',
                        trackId: 'annotations',
                        name: 'Annotations',
                        adapter: {
                            type: 'FromConfigAdapter',
                            features: [],
                        },
                    },
                ],
                location: '1:1000..20000', 
                plugins: loadedPlugins.map(p => p.plugin),
                defaultSession: {
                    name: 'My session',
                    view: {
                        id: 'linearGenomeView',
                        type: 'LinearGenomeView',
                        tracks: [
                            {
                                type: 'FeatureTrack',
                                configuration: 'annotations',
                            },
                        ],
                    },
                },
            });

            console.log('View state created:', viewState);

            render(
                createElement(JBrowseLinearGenomeView, { viewState }),
                document.getElementById('jbrowse_linear_genome_view')
            );

            console.log('JBrowse Linear Genome View rendered.');
        }).catch(error => {
            console.error('Error loading plugins or initializing JBrowse:', error);
        });
    </script>
{% endblock content %}
